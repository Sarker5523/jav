<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Details</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.css" rel="stylesheet" />
  <style>
    :root { --color-back: #1a1a1a; }
    .button {
      background: var(--color-back);
      border-radius: 0.5em;
      box-shadow: inset rgba(54,69,75,1) -1px -1px 6px 0px, rgb(55,72,78) -1px -1px 6px 0px;
      border: solid 2px #030f14;
      cursor: pointer;
      font-size: 16px;
      padding: 0.5em 1.2em;
      outline: none;
      transition: all 0.3s;
      user-select: none;
      min-width: 120px;
    }
    .button:hover { box-shadow: inset 0 -6px 18px -6px #030f14, inset 0 6px 18px -6px #030f14, -1px -1px 6px 0px #0099ff; }
    .button:active, .button.active {
      box-shadow: inset 0 -12px 20px -6px #030f14, inset 0 12px 20px -6px #030f14, -1px -1px 8px 0px #0099ff;
    }
    .button .text { color: #d0a756; font-weight: 700; transition: transform 0.3s; }
    .button:hover .text { transform: scale(0.92); }
    .button:active .text { transform: scale(0.85); }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Navbar (unchanged) -->
  <nav class="bg-white border-gray-200 dark:bg-gray-900 border-b border-gray-800">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8" alt="Logo" />
        <span class="text-2xl font-semibold dark:text-white">VideoHub</span>
      </a>
      <div class="flex md:order-2 space-x-3">
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 20 20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
            </svg>
          </div>
          <input type="text" id="search-navbar" class="block w-full p-2 ps-10 text-sm rounded-lg bg-gray-800 border border-gray-700 focus:ring-green-500 focus:border-green-500" placeholder="Search videos, performers...">
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="content-wrapper max-w-5xl mx-auto p-4 lg:p-8">
    <div id="video-details" class="space-y-8"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.2/flowbite.min.js"></script>
  <script>
    const CACHE_TTL = 24 * 60 * 60 * 1000;
    let db = null;

    async function initDB() {
      return new Promise((res, rej) => {
        const req = indexedDB.open('VideoHubCache', 1);
        req.onerror = () => rej(req.error);
        req.onsuccess = () => { db = req.result; res(db); };
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('videos')) db.createObjectStore('videos', { keyPath: 'id' });
        };
      });
    }

    async function getCache(id) {
      if (!db || !id) return null;
      return new Promise(res => {
        const tx = db.transaction('videos', 'readonly');
        const req = tx.objectStore('videos').get(id);
        req.onsuccess = () => {
          const d = req.result;
          res(d && Date.now() - d.ts < CACHE_TTL ? d.payload : null);
        };
      });
    }

    async function putCache(id, payload) {
      if (!db || !id) return;
      const tx = db.transaction('videos', 'readwrite');
      tx.objectStore('videos').put({ id, payload, ts: Date.now() });
    }

    async function loadAllData() {
      const [scenesRes, performersRes, sitesRes] = await Promise.all([
        fetch('scene_details.json').then(r => r.ok ? r.json() : []),
        fetch('performer.json').then(r => r.ok ? r.json() : []),
        fetch('site.json').then(r => r.ok ? r.json() : [])
      ]);
      const performersById = Object.fromEntries(performersRes.filter(p => p._id).map(p => [p._id, p]));
      const sitesById = Object.fromEntries(sitesRes.filter(s => s.id).map(s => [s.id, s]));
      return { scenes: scenesRes, performersById, sitesById };
    }

    async function loadVideo() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) return document.getElementById('video-details').innerHTML = '<p class="text-red-400 text-center">No video ID specified</p>';

      const cached = await getCache(id);
      if (cached) { renderVideo(cached); return; }

      const { scenes, performersById, sitesById } = await loadAllData();
      const sceneItem = scenes.find(s => String(s.data?._id) === id);
      if (!sceneItem || !sceneItem.data) return document.getElementById('video-details').innerHTML = '<p class="text-red-400 text-center">Video not found</p>';

      const d = sceneItem.data;

      // Performers
      const performers = (d.performers || []).map(p => {
        const perf = performersById[p?.parent?._id || p?._id];
        return perf ? { name: perf.name || 'Unknown', id: perf._id } : null;
      }).filter(Boolean);
      if (!performers.length) performers.push({ name: 'Unknown Performer', id: 0 });

      // Studio chain
      const studioChain = [];
      const site = d.site?.id ? sitesById[d.site.id] : null;
      if (site?.name) studioChain.push({ name: site.name, id: site.id });
      if (d.site?.parent_id) {
        const parent = sitesById[d.site.parent_id];
        if (parent?.name) studioChain.push({ name: parent.name, id: parent.id });
      }
      if (d.site?.network_id) {
        const network = sitesById[d.site.network_id];
        if (network?.name && !studioChain.some(s => s.name === network.name)) studioChain.push({ name: network.name, id: network.id });
      }
      if (!studioChain.length) studioChain.push({ name: 'Unknown Studio', id: 0 });

      const payload = {
        id: String(d._id),
        title: (d.title || 'Untitled').trim(),
        description: d.description || 'No description available.',
        thumbnail: d.background?.full || 'https://via.placeholder.com/1200x800?text=No+Image',
        trailer: d.trailer || '',
        videoId: sceneItem.video_id?.trim() || '',
        slug: sceneItem.slug?.trim() || '',
        performers,
        studioChain
      };

      await putCache(id, payload);
      renderVideo(payload);
    }

    function renderVideo(v) {
      const hasUPN = !!v.videoId;
      const hasAbyss = !!v.slug;
      const defaultSrc = hasAbyss ? `https://short.icu/${v.slug}` : hasUPN ? `https://purn.upn.one/#${v.videoId}` : 'about:blank';

      const performersHtml = v.performers.map(p => p.id
        ? `<a href="performer.html?name=${encodeURIComponent(p.name)}" class="text-green-400 hover:underline">${escape(p.name)}</a>`
        : `<span class="text-gray-500">${escape(p.name)}</span>`
      ).join(' • ');

      const studioHtml = v.studioChain.map((s, i) => i === 0 && s.id
        ? `<a href="site.html?id=${s.id}" class="text-green-400 hover:underline">${escape(s.name)}</a>`
        : escape(s.name)
      ).join(' → ');

      // TRAILER SECTION – FIXED & BEAUTIFUL
      let trailerSection = '';
      if (v.trailer) {
        const gdMatch = v.trailer.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (gdMatch) {
          const fileId = gdMatch[1];
          trailerSection = `
            <div class="mt-12">
              <h2 class="text-2xl font-bold mb-4 text-white">Trailer</h2>
              <div class="w-full aspect-video rounded-lg shadow-2xl overflow-hidden bg-black">
                <iframe 
                  src="https://drive.google.com/file/d/${fileId}/preview"
                  class="w-full h-full border-0"
                  allow="autoplay; encrypted-media; fullscreen"
                  allowfullscreen>
                </iframe>
              </div>
            </div>`;
        } else {
          trailerSection = `
            <div class="mt-12">
              <h2 class="text-2xl font-bold mb-4 text-white">Trailer</h2>
              <div class="w-full aspect-video rounded-lg shadow-2xl overflow-hidden bg-black">
                <video controls poster="${v.thumbnail}" class="w-full h-full object-cover">
                  <source src="${v.trailer}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              </div>
            </div>`;
        }
      }

      document.getElementById('video-details').innerHTML = `
        <!-- Main Player -->
        <div class="w-full aspect-video rounded-lg shadow-2xl overflow-hidden bg-black">
          <iframe id="video-iframe" src="${defaultSrc}" class="w-full h-full" 
                  allow="fullscreen; autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
        </div>

        <!-- Source Switcher -->
        ${hasUPN || hasAbyss ? `
          <div class="flex justify-center gap-6 my-8">
            ${hasUPN ? `<button id="btn-upnshare" class="button ${hasUPN && !hasAbyss ? 'active' : ''}"><div class="text">UPNShare</div></button>` : ''}
            ${hasAbyss ? `<button id="btn-abyss" class="button ${!hasUPN && hasAbyss ? 'active' : ''}"><div class="text">Abyss</div></button>` : ''}
          </div>` : ''}

        <!-- Title & Info -->
        <h1 class="text-3xl md:text-4xl font-bold mt-6">${escape(v.title)}</h1>
        <p class="text-gray-300 text-lg leading-relaxed mt-4">${escape(v.description)}</p>
        <div class="mt-6 space-y-2 text-lg">
          <p><span class="text-gray-500">Studio:</span> ${studioHtml}</p>
          <p><span class="text-gray-500">Performers:</span> ${performersHtml}</p>
        </div>

        <!-- Trailer (fixed!) -->
        ${trailerSection}
      `;

      // Button logic
      const iframe = document.getElementById('video-iframe');
      const btnUPN = document.getElementById('btn-upnshare');
      const btnAbyss = document.getElementById('btn-abyss');

      if (btnUPN) btnUPN.onclick = () => { iframe.src = `https://purn.upn.one/#${v.videoId}`; btnUPN.classList.add('active'); btnAbyss?.classList.remove('active'); };
      if (btnAbyss) btnAbyss.onclick = () => { iframe.src = `https://short.icu/${v.slug}`; btnAbyss.classList.add('active'); btnUPN?.classList.remove('active'); };

      // Start with UPNShare if both exist
      if (hasUPN && hasAbyss) btnAbyss.classList.add('active');
      btnUPN.classList.remove('active');
    }

    function escape(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Init
    initDB().finally(loadVideo);
  </script>
</body>
</html>