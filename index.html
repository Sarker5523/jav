<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' https:;
    media-src 'self' https:;
    connect-src 'self' https:;
  ">

  <title>VideoHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

  <!-- Toggle Switch CSS -->
  <style>
    .checkbox-wrapper-8 .tgl { display: none; }
    .checkbox-wrapper-8 .tgl,
    .checkbox-wrapper-8 .tgl:after,
    .checkbox-wrapper-8 .tgl:before,
    .checkbox-wrapper-8 .tgl *,
    .checkbox-wrapper-8 .tgl *:after,
    .checkbox-wrapper-8 .tgl *:before,
    .checkbox-wrapper-8 .tgl + .tgl-btn { box-sizing: border-box; }
    .checkbox-wrapper-8 .tgl + .tgl-btn {
      outline: 0; display: block; width: 4em; height: 2em; position: relative; cursor: pointer;
      user-select: none;
    }
    .checkbox-wrapper-8 .tgl + .tgl-btn:after,
    .checkbox-wrapper-8 .tgl + .tgl-btn:before {
      position: relative; display: block; content: ""; width: 50%; height: 100%;
    }
    .checkbox-wrapper-8 .tgl + .tgl-btn:after { left: 0; }
    .checkbox-wrapper-8 .tgl:checked + .tgl-btn:after { left: 50%; }
    .checkbox-wrapper-8 .tgl-skewed + .tgl-btn {
      overflow: hidden; transform: skew(-10deg); backface-visibility: hidden;
      transition: all 0.2s ease; font-family: sans-serif; background: #0063f79f;
    }
    .checkbox-wrapper-8 .tgl-skewed + .tgl-btn:after,
    .checkbox-wrapper-8 .tgl-skewed + .tgl-btn:before {
      transform: skew(10deg); display: inline-block; transition: all 0.2s ease;
      width: 100%; text-align: center; position: absolute; line-height: 2em;
      font-weight: bold; color: #fff; text-shadow: 0 1px 0 rgba(0,0,0,0.4);
    }
    .checkbox-wrapper-8 .tgl-skewed + .tgl-btn:after { left: 100%; content: attr(data-tg-on); }
    .checkbox-wrapper-8 .tgl-skewed + .tgl-btn:before { left: 0; content: attr(data-tg-off); }
    .checkbox-wrapper-8 .tgl-skewed:checked + .tgl-btn { background: #0a4d31; }
    .checkbox-wrapper-8 .tgl-skewed:checked + .tgl-btn:before { left: -100%; }
    .checkbox-wrapper-8 .tgl-skewed:checked + .tgl-btn:after { left: 0; }
  </style>

  <style>
    nav { background-color: #1f2937; border-bottom: 1px solid #374151; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #111827; color: #fff; margin: 0; padding: 0; }
    #nav-menu ul { display: flex; flex-direction: column; margin: 0; padding: 0.5rem 0 0 0; list-style: none; font-weight: 500; }
    #nav-menu a { display: block; padding: 0.75rem 1.5rem; color: #e5e7eb; transition: background-color 0.2s, color 0.2s; }
    #nav-menu a:hover { background-color: #374151; color: #86efac; }
    @media (min-width: 768px) {
      #middle-group { display: flex; align-items: center; gap: 1.25rem; }
      #nav-menu ul { flex-direction: row; gap: 1.5rem; padding: 0; }
      #nav-menu a { padding: 0; color: #d1d5db; background-color: transparent; }
      #nav-menu a:hover { background-color: transparent; color: #86efac; }
    }
    #nav-menu a.active { color: #86efac; font-weight: 600; }
    .actress-box{
      --base-font-size: 0.7em;
     position: absolute;
      font-size: var(--base-font-size);
      bottom: auto;
      top: 4px;
      left: 2px;
      right: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 3px 5px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-900">

  <!-- NAVBAR -->
  <nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="index.html" class="flex items-center space-x-3">
        <img src="https://flowbite.com/docs/images/logo.svg" class="h-8 w-auto" alt="VideoHub Logo" />
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">VideoHub</span>
      </a>

      <div class="checkbox-wrapper-8">
        <input type="checkbox" id="data-toggle" class="tgl tgl-skewed">
        <label for="data-toggle" data-tg-off="IRL" data-tg-on="JAV" class="tgl-btn"></label>
      </div>

      <div id="middle-group" class="hidden md:flex items-center order-2 md:order-1">
        <div id="nav-menu">
          <ul>
            <li><a href="site.html">Sites</a></li>
            <li><a href="performer.html">Performers</a></li>
          </ul>
        </div>
      </div>

      <div class="flex md:order-2 space-x-3 items-center">
        <div class="relative hidden md:block">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/></svg>
          </div>
          <input type="text" id="search-navbar" class="block w-full p-2 ps-10 text-sm rounded-lg bg-gray-700 border-gray-600 placeholder-gray-400 text-white focus:ring-green-500 focus:border-green-500" placeholder="Search..." oninput="debouncedSearch()">
          <div id="search-suggestions" class="search-suggestions hidden absolute z-10 w-full bg-gray-800 rounded-b-lg shadow-lg mt-1"></div>
        </div>

        <button data-collapse-toggle="navbar-search" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm rounded-lg md:hidden hover:bg-gray-700">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 17 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/></svg>
        </button>
      </div>

      <div class="hidden w-full" id="navbar-search">
        <div class="relative mt-3">
          <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/></svg>
          </div>
          <input type="text" id="search-navbar-mobile" class="block w-full p-2 ps-10 text-sm rounded-lg bg-gray-700 border-gray-600 placeholder-gray-400 text-white" placeholder="Search..." oninput="debouncedSearch()">
          <div id="search-suggestions-mobile" class="search-suggestions hidden absolute z-10 w-full bg-gray-800 rounded-b-lg shadow-lg mt-1"></div>
        </div>

        <div id="nav-menu" class="mt-4">
          <ul>
            <li><a href="site.html">Sites</a></li>
            <li><a href="performer.html">Performers</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="pagination" id="pagination-top"></div>
  <div class="video-list-container max-w-7xl mx-auto px-4 py-8">
    <div class="video-list grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6" id="video-list">Loading videos...</div>
  </div>
  <div class="pagination" id="pagination-bottom"></div>

  <script defer>
    const itemsPerPage = 12;
    let allVideos = [];
    let filteredVideos = [];
    let currentPage = 1;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('page')) currentPage = Math.max(1, parseInt(urlParams.get('page')) || 1);

    const videoList = document.getElementById('video-list');
    const paginationTop = document.getElementById('pagination-top');
    const paginationBottom = document.getElementById('pagination-bottom');
    const searchInput = document.getElementById('search-navbar');
    const searchInputMobile = document.getElementById('search-navbar-mobile');
    const suggestions = document.getElementById('search-suggestions');
    const suggestionsMobile = document.getElementById('search-suggestions-mobile');

    let performersById = {};
    let searchTimeout = null;

    const mainToggle = document.getElementById('data-toggle');

    const datasets = {
      irl: { scenes: 'scene_details.json', performers: 'performer.json' },
      jav: { scenes: 'scene_details_jav.json', performers: 'performer_jav.json' }
    };

    let currentDataset = localStorage.getItem('selectedDataset') || 'irl';
    mainToggle.checked = currentDataset === 'jav';

    async function loadAllData() {
      const ds = datasets[currentDataset];
      videoList.innerHTML = 'Loading videos...';

      try {
        const [sceneRes, perfRes] = await Promise.all([
          fetch(ds.scenes).then(r => r.ok ? r.json() : []),
          fetch(ds.performers).then(r => r.ok ? r.json() : [])
        ]);

        performersById = {};
        perfRes.forEach(p => { if (p._id) performersById[p._id] = p; });

        allVideos = sceneRes.map(item => {
          const d = item.data || {};
          const performers = d.performers || [];
          const title = (typeof d.title === 'string' && d.title.trim()) ? d.title.trim() : 'Untitled Video';

          // === BEST LINK IDENTIFIER ===
          let linkId = '';
          if (d._id) {
            linkId = String(d._id);
          } else if (item.slug && typeof item.slug === 'string' && item.slug.trim()) {
            linkId = item.slug.trim();
          } else if (item.video_id) {
            linkId = item.video_id;
          } else {
            linkId = 'unknown-' + Date.now();
          }

          // === ACTRESS NAME (Handles both formats) ===
          let actressName = 'Unknown';
          const allPerformerIds = [];

          const perfArray = Array.isArray(performers) ? performers : (performers ? [performers] : []);

          // Priority 1: Direct name
          for (const perf of perfArray) {
            if (perf?.name && typeof perf.name === 'string' && perf.name.trim()) {
              actressName = perf.name.trim();
              break;
            }
          }

          // Priority 2: Parent ID lookup
          if (actressName === 'Unknown') {
            for (const perf of perfArray) {
              if (perf?.parent?._id) {
                const perfId = perf.parent._id;
                allPerformerIds.push(perfId);
                const p = performersById[perfId];
                if (p && (p.extras?.gender === 'Female' || !p.extras?.gender)) {
                  actressName = p.name || 'Unknown';
                  break;
                }
              }
            }
          }

          // Final fallback
          if (actressName === 'Unknown' && allPerformerIds.length > 0) {
            const first = performersById[allPerformerIds[0]];
            if (first?.name) actressName = first.name;
          }

          return {
            linkId,
            title,
            thumbnail: d.background?.full || 'https://via.placeholder.com/300x200?text=No+Image',
            actressName,
            allPerformerIds,
            raw: item
          };
        }).filter(v => v.linkId);

        allVideos.reverse();
        filteredVideos = [...allVideos];
        renderPage();
        renderPagination();
      } catch (err) {
        videoList.innerHTML = `<div class="col-span-full text-center p-8 text-red-400">Failed to load: ${err.message}<br><button onclick="location.reload()" class="mt-4 px-4 py-2 bg-green-700 rounded">Retry</button></div>`;
      }
    }

    mainToggle.addEventListener('change', () => {
      currentDataset = mainToggle.checked ? 'jav' : 'irl';
      localStorage.setItem('selectedDataset', currentDataset);
      currentPage = 1;
      loadAllData();
    });

    function renderPage() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageVideos = filteredVideos.slice(start, end);

      videoList.innerHTML = '';
      if (!pageVideos.length) {
        videoList.innerHTML = '<p class="col-span-full text-center text-gray-400 p-8">No videos found.</p>';
        return;
      }

      pageVideos.forEach(v => {
        const div = document.createElement('div');
        div.className = 'video-item group';
        div.innerHTML = `
          <a href="video.html?id=${encodeURIComponent(v.linkId)}">
            <img src="${v.thumbnail}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'" class="w-full h-auto object-cover rounded-lg shadow-md group-hover:shadow-xl transition-shadow">
            <h3 class="mt-2 text-sm line-clamp-2 font-medium">${escapeHtml(v.title)}</h3>
            <div class="actress-box">${escapeHtml(v.actressName)}</div>
          </a>`;
        videoList.appendChild(div);
      });
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredVideos.length / itemsPerPage);
      [paginationTop, paginationBottom].forEach(container => {
        container.innerHTML = '';
        if (totalPages <= 1) return;
        container.className = 'flex justify-center my-8 flex-wrap gap-2';

        const btn = (page, txt, active = false) => {
          const a = document.createElement('a');
          a.href = `index.html?page=${page}`;
          a.textContent = txt;
          a.className = `px-4 py-2 rounded text-sm ${active ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`;
          return a;
        };

        container.appendChild(btn(1, '« First'));
        const max = 5;
        let start = Math.max(1, currentPage - Math.floor(max / 2));
        let end = Math.min(totalPages, start + max - 1);
        if (end - start < max - 1) start = Math.max(1, end - max + 1);
        for (let i = start; i <= end; i++) {
          container.appendChild(btn(i, i, i === currentPage));
        }
        container.appendChild(btn(totalPages, 'Last »'));
      });
    }

    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, 350);
    }

    function handleSearch() {
      const query = (searchInput?.value || searchInputMobile?.value || '').trim().toLowerCase();
      hideSuggestions();

      if (!query) {
        filteredVideos = [...allVideos];
      } else {
        filteredVideos = allVideos.filter(v =>
          v.title.toLowerCase().includes(query) ||
          v.actressName.toLowerCase().includes(query) ||
          v.allPerformerIds.some(id => performersById[id]?.name?.toLowerCase().includes(query))
        );
      }
      currentPage = 1;
      renderPage();
      renderPagination();
      if (query) showSuggestions(query);
    }

    function showSuggestions(query) {
      const results = allVideos.filter(v => v.title.toLowerCase().includes(query) || v.actressName.toLowerCase().includes(query)).slice(0, 6);
      const render = (container) => {
        container.innerHTML = results.length ? results.map(v => `
          <div class="suggestion-item flex items-center p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-0" data-link-id="${v.linkId}">
            <img src="${v.thumbnail}" loading="lazy" class="w-12 h-12 object-cover rounded mr-3" onerror="this.src='https://via.placeholder.com/48x48?text=No+Image'">
            <div><div class="text-sm font-medium truncate">${escapeHtml(v.title)}</div><div class="text-xs text-green-400">${escapeHtml(v.actressName)}</div></div>
          </div>`).join('') : '<div class="p-3 text-sm text-gray-400">No results</div>';
        container.classList.toggle('hidden', !results.length);
      };
      render(suggestions);
      render(suggestionsMobile);
      document.querySelectorAll('.suggestion-item').forEach(el => {
        el.onclick = () => {
          window.location.href = `video.html?id=${encodeURIComponent(el.dataset.linkId)}`;
        };
      });
    }

    function hideSuggestions() {
      suggestions.classList.add('hidden');
      suggestionsMobile.classList.add('hidden');
    }

    searchInput?.addEventListener('input', () => { searchInputMobile.value = searchInput.value; debouncedSearch(); });
    searchInputMobile?.addEventListener('input', () => { searchInput.value = searchInputMobile.value; debouncedSearch(); });

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && (document.activeElement === searchInput || document.activeElement === searchInputMobile)) {
        const q = (searchInput?.value || '').trim();
        if (q) window.location.href = `search.html?query=${encodeURIComponent(q)}`;
      }
    });

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    loadAllData();
  </script>
</body>
</html>
